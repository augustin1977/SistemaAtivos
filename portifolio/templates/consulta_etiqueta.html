{% extends 'base.html' %}
{% block 'titulo' %}Consulta de Etiquetas{% endblock %}
{% block 'menu' %}{% include 'menu.html' %}{% endblock %}

{% block 'conteudo' %}
<br>
<div class="container mt-5">
  <h2 class="text-center mb-2">üîç Consulta de Etiquetas</h2>

  <form method="get" id="form-consulta" class="text-center mb-1">
      <input type="text" id="campo-busca" name="q" value="{{ query }}"
             placeholder="Digite ou escaneie o c√≥digo"
             class="form-control form-control-lg text-center" autofocus required>
     <!-- <button type="submit" class="btn btn-primary mt-3">Buscar</button> -->
  </form>
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-danger text-center">{{ message }}</div>
    {% endfor %}
  {% endif %}

  {% if etiqueta %}
  <div class="card shadow-lg mt-0">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Etiqueta: {{ etiqueta.codigo_humano }}</h5>
      <a href="{% url 'solicita_impressao_etiqueta' etiqueta.id %}" class="btn btn-info btn-sm">
        <i class="bi bi-printer"></i> Reimprimir
      </a>
    </div>
    <div class="card-body">
      <strong>C√≥digo num√©rico:</strong> {{ etiqueta.codigo_numerico }}<br>
      <strong>C√≥digo humano:</strong> {{ etiqueta.codigo_humano }}<br>
      <strong>Projeto:</strong> {{ etiqueta.amostra.projeto.nome }}<br>
      <strong>Empresa:</strong> {{ etiqueta.amostra.projeto.cliente }}<br>
      <strong>Amostra:</strong> {{ etiqueta.amostra.nome }}<br>
      <strong>Respons√°vel:</strong> {{ etiqueta.amostra.projeto.responsavel }}<br>
      <strong>Local:</strong> {{ etiqueta.local_instalacao }}<br>
      <strong>Massa (kg):</strong> {{ etiqueta.massa }}<br>
      <strong>Observa√ß√£o:</strong> {{ etiqueta.observacao|default:"‚Äî" }}<br>
      <strong>Data de Cria√ß√£o:</strong> {{ etiqueta.data_criacao|date:"d/m/Y H:i" }}<br>
      <strong>√öltima Altera√ß√£o:</strong> {{ etiqueta.data_alteracao|date:"d/m/Y H:i" }}<br>
    </div>
  </div>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form  = document.getElementById("form-consulta");
    const input = document.getElementById("campo-busca");

    if (!input || !form) return;

    // 1) Garante foco e cursor no FIM do texto ap√≥s o reload
    const len = input.value.length;
    input.focus({ preventScroll: true });
    // Alguns navegadores precisam do setTimeout pra aplicar depois do paint
    setTimeout(() => {
      try { input.setSelectionRange(len, len); } catch(e) {}
    }, 0);

    // 2) Debounce: s√≥ envia ap√≥s 500ms e com pelo menos 3 chars
    let timeout = null;
    input.addEventListener("input", function () {
      clearTimeout(timeout);
      const valor = this.value.trim();
      if (valor.length >= 3) {
        timeout = setTimeout(() => {
          // S√≥ envia se o usu√°rio ainda est√° no campo (evita submit ‚Äúfantasma‚Äù)
          if (document.activeElement === input) {
            form.submit();
          }
        }, 800);
      }
    });
  });
</script>
{% endblock %}